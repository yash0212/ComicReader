<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>ComicReader</title>
		<link
			rel="stylesheet"
			href="./node_modules/font-awesome/css/font-awesome.min.css"
		/>
		<link rel="stylesheet" href="./styles/comicdir.css" />
		<script src="./Uint8ToString.js"></script>
	</head>
	<body>
		<!-- <i class="fa fa-folder-o" style="font-size: 50px;"></i> -->
		<div id="directory"></div>
		<script>
			const Store = require("electron-store");
			const path = require("path");
			var fs = require("fs");
			const store = new Store();
			const comicDir = store.get("comicDir");
			const unzipper = require("unzipper");
			var unrar = require("electron-unrar-js");

			var filesAndFolders = fs.readdirSync(comicDir);
			var files = [];
			var folders = [];
			for (const fileorFolder of filesAndFolders) {
				let pathToFile = path.join(comicDir, fileorFolder);
				let stat = fs.statSync(pathToFile);
				if (stat.isDirectory()) {
					folders.push({
						name: fileorFolder,
						path: pathToFile
					});
				} else {
					files.push({
						name: fileorFolder,
						path: pathToFile
					});
				}
			}
			for (const folder of folders) {
				var dirEl = document.getElementById("directory");
				dirEl.innerHTML = dirEl.innerHTML.concat(
					`
								<div class="tile">
									<img src="./images/folder-icon.png" class="folder-icon"/>
									<div>${folder.name}</div>
								</div>
								`
				);
			}
			for (const file of files) {
				var imgFound = 0;
				var imgData = "";
				if (
					path.extname(file.path) === ".cbz" ||
					path.extname(file.path) === ".zip"
				) {
					fs.createReadStream(file.path)
						.pipe(unzipper.Parse())
						.on("entry", async function(entry) {
							const fileName = entry.path;
							const type = entry.type; // 'Directory' or 'File'
							const size = entry.vars.uncompressedSize; // There is also compressedSize;
							let obj;
							if (
								!imgFound &&
								type == "File" &&
								fileName.endsWith(".jpg")
							) {
								imgFound = 1;
								obj = await entry.buffer();
								imgData = obj.toString("base64");
								// document.getElementById("test").src =
								// 	"data:image/jpeg;base64, " +
								// 	obj.toString("base64");
								var dirEl = document.getElementById(
									"directory"
								);
								dirEl.innerHTML = dirEl.innerHTML.concat(
									`
										<div class="tile">
											<img src="data:image/jpeg;base64, ${imgData}" class="comicThumbnail"/>
											<div>${file.name}</div>
										</div>
									`
								);
							} else {
								entry.autodrain();
							}
						});
				} else if (
					path.extname(file.path) === ".cbr" ||
					path.extname(file.path) === ".rar"
				) {
					// Read the archive file into a typedArray
					var buf = Uint8Array.from(fs.readFileSync(file.path))
						.buffer;
					var extractor = unrar.createExtractorFromData(buf);

					var fileList = extractor.getFileList();
					if (fileList[0].state === "SUCCESS") {
						let found = 0;
						var thumbnailFileName = fileList[1].fileHeaders
							.sort((a, b) =>
								a.name.toLowerCase() < b.name.toLowerCase()
									? -1
									: 0
							)
							.filter(x => {
								if (!found && path.extname(x.name) == ".jpg") {
									found = 1;
									return true;
								}
							})
							.map(x => x.name);

						var extracted = extractor.extractFiles([
							thumbnailFileName
						]);

						if (extracted[0].state === "SUCCESS") {
							if (
								extracted[1].files[0].extract[0].state ===
								"SUCCESS"
							) {
								imgData = extracted[1].files[0].extract[1];
								var dirEl = document.getElementById(
									"directory"
								);
								imgData = Uint8ToString(imgData);

								dirEl.innerHTML = dirEl.innerHTML.concat(
									`
										<div class="tile">
											<img src="data:image/jpeg;base64, ${imgData}" class="comicThumbnail"/>
											<div>${file.name}</div>
										</div>
									`
								);
							}
						}
					}
				}
			}
		</script>
	</body>
</html>
