<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>ComicReader</title>
		<link
			rel="stylesheet"
			href="./node_modules/font-awesome/css/font-awesome.min.css"
		/>
		<link rel="stylesheet" href="./styles/comicdir.css" />
		<!-- <script src="./Uint8ToString.js"></script> -->
	</head>
	<body>
		<!-- <i class="fa fa-folder-o" style="font-size: 50px;"></i> -->
		<div id="directory"></div>
		<script>
			const Store = require("electron-store");
			const path = require("path");
			var fs = require("fs");
			const store = new Store();
			const comicDir = store.get("comicDir");
			// const unzipper = require("unzipper");
			// var unrar = require("electron-unrar-js");
			const { fork } = require("child_process");

			var filesAndFolders = fs.readdirSync(comicDir);
			var files = [];
			var folders = [];
			for (const fileorFolder of filesAndFolders) {
				let pathToFile = path.join(comicDir, fileorFolder);
				let stat = fs.statSync(pathToFile);
				if (stat.isDirectory()) {
					folders.push({
						name: fileorFolder,
						path: pathToFile
					});
				} else {
					files.push({
						name: fileorFolder,
						path: pathToFile
					});
				}
			}
			for (const folder of folders) {
				var dirEl = document.getElementById("directory");
				dirEl.innerHTML = dirEl.innerHTML.concat(
					`
					<div class="tile">
						<img src="./images/folder-icon.png" class="folder-icon"/>
						<div>${folder.name}</div>
						</div>
						`
				);
			}
			for (const file of files) {
				var dirEl = document.getElementById("directory");
				dirEl.innerHTML = dirEl.innerHTML.concat(
					`
					<div class="tile">
						<img src="" class="comicThumbnail" id="${file.name}"/>
						<div>${file.name}</div>
					</div>
					`
				);
			}

			var thumbnailQueue = [...files];

			for (let i = 0; i < 3; i++) {
				let thumbnailFork = fork("./fileThumbnail.js");
				thumbnailFork.on("message", data => {
					imgData = data.imgData;
					id = data.file.name;
					document.getElementById(id).src =
						"data:image/jpeg;base64, " + imgData;
					if (thumbnailQueue.length > 0) {
						thumbnailFork.send(thumbnailQueue.shift());
					} else {
						thumbnailFork.kill();
					}
				});
				if (thumbnailQueue.length > 0) {
					thumbnailFork.send(thumbnailQueue.shift());
				}
			}
		</script>
	</body>
</html>
